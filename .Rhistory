library(httr)
library(jsonlite)
library(ggplot2)
library(DescTools)
library(tidyverse)
library(magrittr)
library(rlang)
library(lubridate)
library(anytime)
library(readr)
library(yaml)
# Load function for posting GQL-queries and retrieving data:
source("functions/GQL_function.r")
configs <-
read_yaml("vegvesen_configs.yml")
gql_metadata_qry <- read_file("gql-queries/station_metadata.gql")
stations_metadata <-
GQL(
query=gql_metadata_qry,
.url = configs$vegvesen_url
)
source("functions/data_transformations.r")
stations_metadata
stations_metadata[[1]][[1]] %>%
as_tibble()
stations_metadata[[1]] %>%
as_tibble()
stations_metadata[[1]] %>%
map(as_tibble) %>%
list_rbind()
unlist_safe <-
function(x) {
x <- unlist(x)
if (is.null (x)) {
return(NA_character_)
}else{return(x)}
}
stations_metadata[[1]] %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "Europe/Berlin")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)
transform_metadata_to_df <-
function(stations_metadata) {
stations_metadata %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "Europe/Berlin")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)
}
transform_metadata_to_df([[1]])
transform_metadata_to_df()
transform_metadata_to_df(stations_metadata = 1)
transform_metadata_to_df(stations_metadata[[1]])
transform_metadata_to_df <-
function(stations_metadata) {
stations_metadata %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "UTC")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)
}
transform_metadata_to_df(stations_metadata[[1]])
transform_metadata_to_df(.)
transform_metadata_to_df([[1]])
transform_metadata_to_df(stations_metadata = 1)
transform_metadata_to_df(stations_metadata)
transform_metadata_to_df(stations_metadata[1])
transform_metadata_to_df(stations_metadata[[1]])
stations_metadata %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "UTC")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)
stations_metadata[[1]] %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "UTC")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)
# Function transforming metadata to dataframe
transform_metadata_to_df <-
function(stations_metadata[[1]]) {
transform_metadata_to_df <-
function(y) {
{y <- stations_metadata}
{stations_metadata %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "UTC")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)}
}
transform_metadata_to_df <-
function(y) {
{y <- stations_metadata[[1]]}
{stations_metadata[[1]] %>%
map(as_tibble) %>%
list_rbind() %>%
mutate(latestData = map_chr(latestData, unlist_safe)) %>%
mutate(latestData = as_datetime(latestData, tz = "UTC")) %>%
unnest_wider(location) %>%
unnest_wider(latLon)}
}
transform_metadata_to_df()
transform_metadata_to_df(.)
stations_metadata_df <-
stations_metadata %>%
transform_metadata_to_df(.)
stations_metadata_df
